# Practice tests 1 - Cluster Architecture, Installation and Configuration

## RBAC


* Create a role that will allow users to get, list, watch pods and view container logs

```
k create role pod-reader --resource=pod --resource=pod/log --verb=list --verb=get --verb=watch --dry-run -o yaml > pod-reader.yaml
k apply -f pod-reader.yaml
```

* Create a rolebinding that binds the role pod-reader to a user named `dev`

```
k create rolebinding podreader-dev --role=podreader --user=dev --dry-run=client -o yaml > podreader-dev.yaml
k apply -f podreader-dev.yaml
```

* Create a new service account `secretguy` and give it permissions to list and get secrets in the namespace

```
k create serviceaccount secretguy
k create role secretreader --resource=secret --verb=list --verb=get --dry-run=client -o yaml > secretreader.yaml
k apply -f secretreader.yaml
k create rolebinding secretreader-binding --role=secretreader --serviceaccount="default:secretguy" --dry-run=client -o yaml > secretguy-binding.yaml
k apply -f secretguy-binding.yaml
```

## Kubeadm

* Create a basic kubernetes cluster with `kuberadm` with CIDR `10.244.0.0/16`. Assume docker, kubeadm, kubectl etc. are preinstalled

```
sudo kubeadm init --pod-network-cidr=10.244.0.0/16
```

* Join a worker node to existing cluster using kuberadm

Run this on existing master
```
kubeadm token create --print-join-command
```

Copy the join command and run on the new cluster

* Remove a node from running cluster

Drain existing pods

```
kubectl drain  <node-name> --delete-local-data --ignore-daemonsets
```

Avoid scheduling to the node
```
kubectl cordon <node-name>
```

Reset node (run inside the node)

```
sudo kubeadm reset
```

Remove node

```
kubecl delete node node-name
```

# Notes

* Create the role using `k create role` command. Use `k create role -h` help if get stuck
* API Group need not be provided. It will be filled automatically with create role command
* Write to yaml, verify and apply it
* use `--as=username` and `--as-group=groupname` to run kubectl commands as a particular user and group

* kubeadm create token --print-join-command returns the command to join from other clusters. Adding the token and sha manually is painful.
* Drain pods and remove node from scheduling before removing the node
* You can take certificates generated by kubeadm from `/etc/kubernetes/pki` folder and verify them online to view the fields
* Use pod-network-cidr=192.168.0.0/16 if using calico (that is their default config)
* Flannel also needs pod-network-cidr to be provided. Otherwise flannel pods will fail
* Coredns pods won't start until pod network is installed
* Untaint master to allow scheduling pods to master
